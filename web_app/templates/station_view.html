{% extends "base.html" %}
{% block title %}{{ name }}{% endblock %}
{% block head %}
    {{ super() }}
    <style type="text/css">
        .wrapper {
            display: grid;
            grid-template-rows: 8% 92%;
            grid-template-columns: 50% 25% 25%;
            width: 100vw;
            height: 100vh;
        }

        .head {
            grid-column: 1;
        }

        .head_in {
            grid-column: 2;
        }

        .head_out {
            grid-column: 3;
        }

        .svg_map {
            height: 100%;
            width: 100%;
            background-color: #AEAEAE;
        }

        .map {
            background-color: #666;
            grid-row: 2;
            grid-column: 1;
        }

        .input {
            background-color: #555;
            grid-row: 2;
            grid-column: 2;

            position: relative;

            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .output {
            background-color: #555;
            grid-row: 2;
            grid-column: 2;
            padding: 20px;
            position: relative;

            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: gray;
            border-radius: 10px;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: teal;
        }

        .scroll {
            max-height: 100%;
            padding: 20px;
            overflow: auto;
        }

        .output {
            background-color: #666;
            grid-row: 2;
            grid-column: 3;

        }

        #calculate {
            width: 100%;
        }

        .sphere {
            fill: #006994;
            stroke: #333;
        }

        .land {
            fill: #567D46;
            stroke: #333;
            stroke-linejoin: round;
            stroke-linecap: round;
            vector-effect: non-scaling-stroke;
        }

        .boundary {
            fill: none;
            stroke: #333;
            stroke-linejoin: round;
            stroke-linecap: round;
            vector-effect: non-scaling-stroke;
        }

        .data_input label {
            font-size: 10px;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="wrapper">
        <div class="w3-container w3-blue-grey head">
            <h1>{{ name }} lat: {{ lat }} lon: {{ lng }}</h1>
        </div>
        <div class="w3-container w3-teal head_in">
            <h1>Input</h1>
        </div>
        <div class="w3-container w3-blue-grey head_out">
            <h1>Output</h1>
        </div>


        <div class="map">
            <svg id="svg_map" width="100%" height="100%"></svg>
        </div>

              <div class="input">
            <div class="scroll">
                <div class="w3-card-4 data_input">
                    <header class="w3-container w3-teal">
                        <h2>Data</h2>
                    </header>
                    <div class="w3-container w3-white">
                        {% for segment in file_ns %}
                            <p>
                            <div>
                                <input class="w3-check" type="checkbox">
                                <label>{{ segment }}</label>
                            </div>
                            </p>
                        {% endfor %}
                    </div>
                </div>
                <P></P>
                <div class="w3-card-4 render_all">
                    <header class="w3-container w3-teal">
                        <h2>Rendering</h2>
                    </header>
                    <div class="w3-container w3-white">
                            <p>
                            <div>
                                <input class="w3-check" id="render_all_check" type="checkbox">
                                <label>Render all Trajectories</label>
                            </div>
                            </p>
                    </div>
                </div>
                <P></P>
                <div class="w3-card-4">
                    <header class="w3-container w3-teal">
                        <h2>Sector</h2>
                    </header>
                    <div class="w3-container w3-white">
                        <P>
                            <label>Start angle</label>
                            <input class="w3-input" id="start_angle_val" type="number" value=150>
                        <P>
                            <label>End angle</label>
                            <input class="w3-input" id="end_angle_val" type="number" value=270>
                        <P>
                            <label>Distance</label>
                            <input class="w3-input" id="sec_dist_val" type="number" value=50>
                        <P>
                            <label>Threshold (time outside sector)</label>
                            <input class="w3-input" id="sec_threshold_val" type="number" value=5>
                        <P>
                            <input class="w3-button w3-teal" id="add_sector" type="button" value="Add">
                    </div>

                </div>

                <p></p>
                <div class="w3-card-4">
                    <header class="w3-container w3-teal">
                        <div class="w3-row-padding">
                            <div class="w3-half">
                                <h2>Filter</h2>
                            </div>
                            <div class="w3-half">
                                <P></P>
                                <select id="filter_option" class="w3-select" name="option">
                                    <option value="height">Height</option>
                                    <option value="pressure">Pressure</option>
                                </select>
                            </div>
                        </div>
                    </header>
                    <div class="w3-container w3-white">
                        <P></P>
                        <label>Min</label>
                        <input class="w3-input" id="filter_min_val" type="number" value=0>
                        <P></P>
                        <label>Max</label>
                        <input class="w3-input" id="filter_max_val" type="number" value=0>
                        <P></P>
                        <label>Threshold</label>
                        <input class="w3-input" id="filter_thresh_val" type="number" value=0>
                        <P></P>
                        <input class="w3-button w3-teal" id="add_filter" type="button" value="Add">
                        <P></P>
                    </div>

                </div>
                <p></p>
                <div class="w3-card-4" id="dbscan_div">
                    <header class="w3-container w3-teal">
                        <h2>DBScan Cluster</h2>
                    </header>
                    <div class="w3-container w3-white">
                        <P>
                            <!--
                            Old K-means style menu
                            <label>Number of clusters</label>
                            <input class="w3-input" id="number_of_cluster" type="number" value=0>
                             -->

                            <label>Minimum Samples for Cluster</label>
                            <input class="w3-input" id="minimum_samples_for_cluster" type="number" value="10">

                            <label>EPS Value (neighbourhood point radius)</label>
                            <input class="w3-input" id="eps_value" type="number" value="50">
                        <P>
                            <input class="w3-button w3-teal" id="add_cluster" type="button" value="Add">
                    </div>
                    <p></p>
                <div class="w3-card-4" id="kmeans_div">
                    <header class="w3-container w3-teal">
                        <h2>K-Means Cluster</h2>
                    </header>
                    <div class="w3-container w3-white">
                        <P>
                            <label>Number of clusters</label>
                            <input class="w3-input" id="number_of_cluster" type="number" value=0>
                        <P>
                            <input class="w3-button w3-teal" id="add_cluster_kmeans" type="button" value="Add">
                    </div>

                </div>
                <P></P>
                <ul class="w3-ul w3-border w3-white" id="stack">

                </ul>
                <p></p>
                <input class="w3-button w3-teal" id="calculate" type="button" value="Calculate" onclick="submitButtonStyle(this)">


            </div>
            </div></div>

        <div class="output">
            <div class="scroll">
                <a id="export_data_button" class="w3-button w3-teal">Export Output</a>


                <div id="debugDiv"></div>
            </div>
        </div>

    </div>
    <script src="{{ url_for('static', filename='javascript/station_utils.js') }}"></script>
    <script src="{{ url_for('static', filename='javascript/station_view_input.js') }}"></script>
    <script src="{{ url_for('static', filename='javascript/sector.js') }}"></script>
    <script>
        // Data files in the stations directory
        let file_ns = "{{ file_ns }}";

        // Id of the stations
        let iid = "{{ id }}";

        // Latitude and longitude of the station
        let lat = {{ lat }};
        let lng = {{ lng }};

        let lats = [], longs = [];
        let p = [];
        let p_ = [];
        let trans = [0, 0, 1];

        let data = null;
        let pp = "{{ url_for('static', filename='stations/CGR/ERA-Interim_1degree_CapeGrim_100m_2016_hourly.json') }}";
        $.getJSON(pp, function (j) {
            data = j;
            renderMap();
        });

        const projection_ = d3.geoAzimuthalEqualArea().rotate([-lng, -lat]);
        const path = d3.geoPath().projection(projection_);
        const zoom = d3.zoom().scaleExtent([1, 9]).on('zoom', zoomed);
        const svg = d3.select('#svg_map')
        let w = parseInt(svg.style("width"));
        const g = svg.append('g').call(d3.zoom().on("zoom", function () {
            svg.attr("transform", d3.event.transform)
        }));

        d3.select('g').attr('transform', 'translate(-' + (w / 2) + ' 0)scale(' + (w / 600) + ')')
        svg.style("width", "100%");
        g.call(zoom);

        function renderMap() {
            d3.json("{{ url_for('static', filename='world-110m2.json') }}")
                .then(world => {
                    g.append('path')
                        .datum({type: 'Sphere'})
                        .attr('class', 'sphere')
                        .attr('d', path);

                    g.append('path')
                        .datum(topojson.merge(world, world.objects.countries.geometries))
                        .attr('class', 'land')
                        .attr('d', path);

                    g.append('path')
                        .datum(topojson.mesh(world, world.objects.countries, (a, b) => a !== b))
                        .attr('class', 'boundary')
                        .attr('d', path);

                    g.append("circle")
                        .attr("cx", projection_([lng, lat])[0])
                        .attr("cy", projection_([lng, lat])[1])
                        .attr("r", 2.5)
                        .style("fill", "white");
                });
        }

        let ll = projection_([lng, lat]);

        function renderSector(start, end, dist) {
            g.select(".arc").remove();
            var arc = d3.arc()
                .innerRadius(0)
                .outerRadius(dist)
                .startAngle(start * (Math.PI / 180))
                .endAngle(end * (Math.PI / 180));
            g.append("path")
                .attr("class", "arc")
                .attr("d", arc)
                .attr("transform", "translate(" + ll[0] * trans[2] + "," + ll[1] * trans[2] + ")" + "translate(" + trans[0] + "," + trans[1] + ")" + "scale(" + trans[2] + ")")
                .attr("fill-opacity", "0.3")
                .style("fill", "#8b0000");
        }


        let lineFunction = d3.line()
            .x(function (d) {
                return projection_([d[1], d[0]])[0];
            })
            .y(function (d) {
                return projection_([d[1], d[0]])[1];
            });


        function renderLines(mm, weight) {
            console.log("For render lines, mm is ");
            console.log(mm);
            g.selectAll(".traj").remove();
            let lat_lng = [mm["lat"], mm["lon"]];

            for (let l = 0; l < lat_lng[0].length; l++) {
                p_ = [];
                lats = lat_lng[0][l];
                longs = lat_lng[1][l];

                for (let i = 0; i < lats.length; i++) {
                    p_.push([lats[i], longs[i]]);
                }
                p.push(p_);
            }


            console.log(p);
            let m = Math.max(...weight);
            for (let i = 0; i < lat_lng[0].length; i++) {
                let w = weight[i];
                g.append("path")
                    .attr("class", "traj")
                    .attr("d", lineFunction(p[i]))

                    .attr("stroke", function () {
                        return "red";
                    })
                    .attr("stroke-width", (w / m) * 2.5)
                    .attr("fill", "none")
                    .attr("transform", "translate(" + trans[0] + "," + trans[1] + ")" + "scale(" + trans[2] + ")");
            }
        }


        function render_all_lines(mm, parse=true) {

            if (parse) {
                mm = JSON.parse(mm);
            }


            // console.log("Running render_all_lines function");
            // console.log("mm is ");
            // console.log(JSON.parse(mm)['lat']);

            g.selectAll(".traj").remove();
            let lat_lng = [mm["lat"], mm["lon"]];
            // console.log(lat_lng);
            // steps in 10
            let p=[];
            for (let l = 0; l < lat_lng[0].length; l+=10) {
                p_ = [];
                lats = lat_lng[0][l];
                longs = lat_lng[1][l];

                // steps in 10
                for (let i = 0; i < lats.length; i+=10) {
                    p_.push([lats[i], longs[i]]);
                }
                p.push(p_);
            }
            console.log(p);
            // let m = Math.max(...weight);
            for (let i = 0; i < lat_lng[0].length; i++) {
                // let w = weight[i];
                g.append("path")
                    .attr("class", "traj")
                    .attr("d", lineFunction(p[i]))

                    .attr("stroke", function () {
                        return "gray";
                    })
                    .attr("stroke-width", 0.5)
                    .attr("fill", "none")
                    .attr("opacity", 0.3)
                    .attr("transform", "translate(" + trans[0] + "," + trans[1] + ")" + "scale(" + trans[2] + ")");
            }
        }


        function zoomed() {
            trans = [d3.event.transform.x, d3.event.transform.y, d3.event.transform.k];
            g.selectAll('path')
                .attr('transform', d3.event.transform);
            g.selectAll('circle')
                .attr('transform', d3.event.transform);
            g.selectAll('.arc').attr("transform", "translate(" + ll[0] * d3.event.transform.k + "," + ll[1] * d3.event.transform.k + ")" + d3.event.transform);
        }


    </script>
{% endblock %}